name: Run Gradle on PRs
on: pull_request
jobs:
    prBranch:
        strategy:
            matrix:
                os: [ubuntu-latest]
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-java@v3
              with:
                  distribution: temurin
                  java-version: 11

            - name: Setup Gradle
              uses: gradle/gradle-build-action@v2
            - name: Execute Gradle build
              env:
                  GE_URL: ${{ secrets.GE_URL }}
                  GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
              run: |
                curl -s "https://get.sdkman.io" | bash
                source "$HOME/.sdkman/bin/sdkman-init.sh"
                sdk install gradleprofiler 0.18.0
                echo $'assemble { \n title= "assemble" \n tasks = [":help"] \n  gradle-args = ["-Dscan.tag.pr", "-Dscan.tag.experiment"] \n}' >scenario


            - name: Archive production artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: cache
                  path: /home/runner/.gradle/caches/transforms-3/9a864bdf6138f0a2c754a9e732c2644a/transformed/output

    mainBranch:
        strategy:
            matrix:
                os: [ubuntu-latest]
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-java@v3
              with:
                  distribution: zulu
                  java-version: 11.0.4

            - name: Setup Gradle
              uses: gradle/gradle-build-action@v2
            - name: Execute Gradle build
              env:
                  GE_URL: ${{ secrets.GE_URL }}
                  GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
              run: |
                  curl -s "https://get.sdkman.io" | bash
                  source "$HOME/.sdkman/bin/sdkman-init.sh"
                  sdk install gradleprofiler 0.18.0
                  echo $'assemble { \n title= "assemble" \n tasks = [":help"]  \n gradle-args = ["-Dscan.tag.main" ,"-Dscan.tag.experiment"] \n}' >scenario
                  git fetch origin
                  git checkout main


            - name: Archive production artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: cache1
                  path: /home/runner/.gradle/caches/transforms-3/bf1362543da86239151d00c56f0b4149/transformed/output

    geapi:
        needs: [prBranch, mainBranch]
        strategy:
            matrix:
                os: [ubuntu-latest]
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-java@v3
              with:
                  distribution: zulu
                  java-version: 11.0.4

            - name: Setup Gradle
              uses: gradle/gradle-build-action@v2
            - name: Execute Gradle build
              env:
                  GE_URL: ${{ secrets.GE_URL }}
                  GRADLE_ENTERPRISE_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
              run: |
                  mkdir geapi
                  cd geapi
                  git clone https://github.com/cdsap/GradleEnterpriseApiReports.git
                  cd GradleEnterpriseApiReports
                  ./gradlew install
                  geapi/build/install/geapi/bin/geapi --help
            - uses: mshick/add-pr-comment@v1
              with:
                message: |
                  **Hello**
                  üåè
                  !
                repo-token: ${{ secrets.GITHUB_TOKEN }}
                repo-token-user-login: 'github-actions[bot]' # The user.login for temporary GitHub tokens
                allow-repeats: run # This is the default
